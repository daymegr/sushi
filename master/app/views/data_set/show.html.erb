<script type="text/javascript">
$(document).ready(function(){
  var samples_length = $("#data_set_samples_length").val();

  // modal form
  var parameter_dialog, submit_dialog, submited_dialog;

  function back_input_parameters(){
    parameter_dialog.dialog( "open" );
    submit_dialog.dialog( "close" );
  }
  function confirm_parameters() {
    var parameters = {};
    var next_dataset_name = $("#container_modal_form1 #next_dataset_name").val();
    var next_dataset_comment = $("#container_modal_form1 #next_dataset_comment").val();
    var sushi_app_class = $("#container_modal_form1 #sushi_app_class").val();
    var data_set_id = $("#container_modal_form1 #data_set_id").val();

    alert(next_dataset_name);
    alert(sushi_app_class);
    alert(data_set_id);
    parameters['sushi_app_class'] = sushi_app_class;
    parameters['data_set_id'] = data_set_id;
    parameters['next_dataset_name'] = next_dataset_name;
    parameters['next_dataset_comment'] = next_dataset_comment;
    var formChildren = $( "#container_modal_form1 #sushi_app_params :input" );
    jQuery.each( formChildren, function( i, ob ) {
      parameters[ob.id] = ob.value;
    });
    $('#container_modal_form2').load('/run_application/confirmation', parameters);

    var dialog_width = window.parent.screen.width*0.7;
    var dialog_height = window.parent.screen.height*0.8;
    submit_dialog = $( "#dialog-form2" ).dialog({
      autoOpen: false,
      height: dialog_height,
      width: dialog_width,
      modal: true,
      buttons: {
        "Back": back_input_parameters,
        "Submit": submit_job,
        Cancel: function() {
          alert("destroy sumit_dialog1");
          parameter_dialog.dialog( "close" );
          alert("destroy sumit_dialog2");
          submit_dialog.dialog( "close" );
          alert("destroy sumit_dialog3");
          parameter_dialog.dialog("destroy");
          alert("destroy sumit_dialog4");
          submit_dialog.dialog("destroy");
          alert("destroy sumit_dialog5");
        }
      },
    });

    submit_dialog.dialog( "open" );
    parameter_dialog.dialog( "close" );
  }
  function submit_job() {
    var parameters = {};
    var next_dataset_name = $("#container_modal_form2 #next_dataset_name").val();
    var next_dataset_comment = $("#container_modal_form2 #next_dataset_comment").val();
    var sushi_app_class = $("#container_modal_form2 #sushi_app_class").val();
    var data_set_id = $("#container_modal_form2 #data_set_id").val();

    alert(next_dataset_name);
    alert(sushi_app_class);
    alert(data_set_id);
    parameters['sushi_app_class'] = sushi_app_class;
    parameters['data_set_id'] = data_set_id;
    parameters['next_dataset_name'] = next_dataset_name;
    parameters['next_dataset_comment'] = next_dataset_comment;
    var formChildren = $( "#container_modal_form2 #sushi_app_params :input" );
    jQuery.each( formChildren, function( i, ob ) {
      parameters[ob.id] = ob.value;
    });
    $('#container_modal_form3').load('/run_application/submit_jobs', parameters);

    var dialog_width = window.parent.screen.width*0.7;
    var dialog_height = window.parent.screen.height*0.8;
    submited_dialog = $( "#dialog-form3" ).dialog({
      autoOpen: false,
      height: dialog_height,
      width: dialog_width,
      modal: true,
      buttons: {
        "Close": function() {
          alert("destroy sumited_dialog1");
          parameter_dialog.dialog( "close" );
          alert("destroy sumited_dialog2");
          submit_dialog.dialog( "close" );
          alert("destroy sumited_dialog3");
          submited_dialog.dialog( "close" );
          alert("destroy sumited_dialog4");
          parameter_dialog.dialog("destroy");
          alert("destroy sumited_dialog5");
          submit_dialog.dialog("destroy");
          alert("destroy sumited_dialog6");
          submited_dialog.dialog("destroy");
          alert("destroy sumited_dialog7");
        }
      },
    });

    submited_dialog.dialog( "open" );
    submit_dialog.dialog( "close" );
  }

  $( ".sushi_app" ).button().on( "click", function() {
    var data_set_id = $("#data_set_id").val();
    var app_name = $(this).text();
    $('#container_modal_form1').load('/run_application/set_parameters', {'app':app_name,  'data_set_id':data_set_id});

    var dialog_width = window.parent.screen.width*0.7;
    var dialog_height = window.parent.screen.height*0.8;
    parameter_dialog = $( "#dialog-form1" ).dialog({
      autoOpen: false,
      height: dialog_height,
      width: dialog_width,
      modal: true,
      buttons: {
        "Next": confirm_parameters,
        Cancel: function() {
          alert("destroy parameter_dialog1");
          parameter_dialog.dialog( "close" );
          alert("destroy parameter_dialog2");
          parameter_dialog.dialog("destroy");
          alert("destroy parameter_dialog3");
        }
      },
    });

    parameter_dialog.dialog( "open" );
  });

  $("#add_comment").click(function(){
    var data_set_id = $("#data_set_id").val();
    var old_comment = $("#data_set_comment").val();
    var new_comment = prompt("add comment", old_comment);

    if (data_set_id != null && new_comment != null) {
      $('#main_content').load('/data_set/add_comment', {'data_set_id':data_set_id, 'data_set_comment':new_comment});
    }
  });
  $("#edit_name").click(function(){
    var data_set_id = $("#data_set_id").val();
    var old_name = $("#data_set_name").val();
    var new_name = prompt("edit name", old_name);

    if (data_set_id != null && new_name != null) {
      $('#main_content').load('/data_set/edit_name', {'data_set_id':data_set_id, 'data_set_name':new_name});
    }
  });
  $("nav.pagination a").click(function(){
    var link = $(this).attr('href');
    $('#main_content').load(link);
  });
});
</script>

<div id=data_set_header>
<h3 style="display: inline-block;">DataSet</h3>
<%= render 'shared/td' %>
- <%= link_to 'add comment', '', :id=>"add_comment" %> 
- <%= link_to 'edit name', '', :id=>"edit_name" %>
<%= hidden_field :data_set, :name, :value=>@data_set.name %>
<%= hidden_field :data_set, :id, :value=>@data_set.id %>
- <%= link_to "download tsv", {:action=>"save_as_tsv", :id=>@data_set.id}, :method=>:post %>
<% if session[:employee] and @data_set.parent_id and @data_set.child == false %>
- <%= link_to "delete only data files", {:action=>"confirm_delete_only_data_files", :id=>@data_set.id}, :method=>:post %>
<% end %>
- <%= link_to 'edit samples', "/sample/#{@data_set.id}", :method=>:post %>
- <%= link_to 'script&log', "/data_set/script_log.#{@data_set.id}", :method=>:get %>
- <%= link_to 'parameters', "/data_set/job_parameter.#{@data_set.id}", :method=>:get %>
</div>
<hr />
<table>
  <tr><th>ID</th><th>Name</th><th>Samples</th><th>Parent</th><th>Child(ren)IDs</th><th>Created</th><th>BFabricID</th></tr>
  <% if @data_set %>
  <%= hidden_field :data_set, :id, :value => @data_set.id %>
  <%= hidden_field :data_set, :samples_length, :value => @data_set.samples.length %>
  <tr>
    <td><%= @data_set.id %></td>
    <td><%= td @data_set.name %></td>
    <td><%= @data_set.samples.length %></td>
    <td><%= link_to td(@data_set.data_set.name), "/data_set/p#{session[:project]}/#{@data_set.parent_id}" if @data_set.data_set %></td>
    <td>
      <% @data_set.data_sets.each do |child| %>
        <%= link_to child.id, "/data_set/#{child.id}" %>
        <%= "," unless child == @data_set.data_sets.last %>
      <% end %>
    </td>
    <td><%= @data_set.created_at.to_s.gsub(/UTC/,'') %></td>
    <% if @data_set.bfabric_id %>
      <td><%= link_to @data_set.bfabric_id, "http://fgcz-bfabric.uzh.ch/bfabric/userlab/show-dataset.html?datasetId=#{@data_set.bfabric_id}&tab=details", target: "_blank" %></td>
    <% else %>
      <td></td>
    <% end %>
  </tr>
  <% end %>
</table>
<ul id="data_set_tree" class="filetree"></ul>
<% if @data_set.comment %>
  <%= hidden_field :data_set, :comment, :value=>@data_set.comment %>
  <%= @data_set.comment %><br />
<% end %>
<hr />
<h3>Samples</h3>

<% if @data_set %>
    <div style="width:100%; overflow-x:scroll;">
<table>
  <tr>
    <% @data_set.factor_first_headers.each do |header| %>
      <th><%= header %></th>
    <% end %>
  </tr>
  <% @samples.each do |sample| %>
    <tr>
      <% @data_set.factor_first_headers.each do |header| %>
        <td>
          <% unless @file_exist[sample.to_hash[header].to_s] %>
            <font color=red><%= File.basename(sample.to_hash[header].to_s) %></font>
          <% else %>
            <% file_path = sample.to_hash[header].to_s %>
            <% file_name = File.basename(file_path) %>
            <% if header.tag?('Link') %>
              <% if file_path =~ /^http/ %>
                <%= link_to td(file_name), file_path, target: "_blank" %>
              <% elsif @fgcz %>
                <%= link_to td(file_name), File.join('http://fgcz-gstore.uzh.ch/projects', file_path), target: "_blank" %>
              <% else %>
                <%= link_to td(file_name), File.join('/projects', file_path) %>
              <% end %>
            <% elsif header.tag?('File') %>
               <%= td file_name %>
            <% elsif @sample_invalid_name[file_name] %>
               <font color=red><%= td file_name %></font>
            <% else %>
               <%= td file_path %>
            <% end %>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>
<%= form_tag({:controller => 'data_set', :action => 'index'}, :method => :get) do %>
  <%= paginate(@samples, :remote => true) %>
    #sample =<%= select :sample, :per_page, {"5" => 5, "10" => 10, "50" => 50, "100" => 100}, :selected => session[:sample_per_page] %> / view <%= submit_tag "Reload" %>
<% end %>
    </div>
<% end %>
<hr />

<% unless @file_exist.values.inject{|a,b| a and b}%>
  <% if @sample_path.length == 1 %>
    <%= button_to "Go gstore", File.join("/projects/", @sample_path.first), :method=>:get %>
  <% end %>
  <font color=red>RED file(s) or the following does not exist in gstore:</font> <%= SushiFabric::GSTORE_DIR %><br />
  <ul>
  <% @file_exist.select{|file, exist| !exist}.each do |file, exist| %>
    <li><%= file %></li>
  <% end %>
  </ul>
<% end %>
  <% @sample_path.sort.each do |path| %>
    <%= link_to "#{File.join('/projects/',path)}", File.join("/projects/", path) %>
  <% end %>

    <hr />
  <% if !@sample_invalid_name.keys.empty? %>
    <h3>Applications</h3>
    <ul>
      <li><font color=red>Invalid character is used in sample name. Please correct it.</font></li>
      <li>Invalid characters: !@#$%^&*()<>{}[]/:;"='+| and SPACE</li>
    </ul>
  <% elsif @sushi_apps %>
    <%= render :partial => '/data_set/sushi_application_list' %>
    <br />
    <form style="display:inline-block;"> <button type="button" id="refresh_sushi_list">refresh</button> </form></h3> 
  <% end %>

<hr />

<div id="dialog-form1" title="Set parameters">
  <%= render :partial => '/data_set/modal_form1' %>
</div>
<div id="dialog-form2" title="Set parameters">
  <%= render :partial => '/data_set/modal_form2' %>
</div>
<div id="dialog-form3" title="Set parameters">
  <%= render :partial => '/data_set/modal_form3' %>
</div>


